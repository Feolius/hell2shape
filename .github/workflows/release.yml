name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.ref }}
      
      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"
      
      - name: Generate Version.php
        run: |
          RELEASE_DATE=$(date +%Y-%m-%d)
          cat > src/Version.php << 'EOF'
          <?php
          
          namespace Feolius\Hell2Shape;
          
          /**
           * Version information for hell2shape.
           * This file is automatically generated during release.
           * Do not edit manually.
           */
          final class Version
          {
              public const VERSION = '${{ steps.version.outputs.VERSION }}-dev';
          
              public const RELEASE_DATE = '$RELEASE_DATE';
          }
          EOF
          
          # Replace placeholders
          sed -i "s/\${{ steps.version.outputs.VERSION }}/${{ steps.version.outputs.VERSION }}/g" src/Version.php
          sed -i "s/\$RELEASE_DATE/$RELEASE_DATE/g" src/Version.php
          
          echo "Generated Version.php:"
          cat src/Version.php
      
      - name: Commit Version.php
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: Update Release Info
      
